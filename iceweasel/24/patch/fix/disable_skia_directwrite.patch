# HG changeset patch
# Parent d6b959018d97e8874fffe31d9e7bc74e3cfcac88
# User hua.andy <hua.andy@gmail.com>
"disable-skia configure for windows"


diff --git a/configure.in b/configure.in
--- a/configure.in
+++ b/configure.in
@@ -8116,17 +8116,17 @@ fi
 AC_SUBST(GLIB_CFLAGS)
 AC_SUBST(GLIB_LIBS)
 AC_SUBST(GLIB_GMODULE_LIBS)
 
 dnl ========================================================
 dnl Graphics checks.
 dnl ========================================================
 
-if test "${OS_TARGET}" = "WINNT" -o "${OS_ARCH}" = "Darwin" -o "${MOZ_WIDGET_TOOLKIT}" = "android" -o "${MOZ_WIDGET_TOOLKIT}" = "gtk2"; then
+if test "${OS_ARCH}" = "Darwin" -o "${MOZ_WIDGET_TOOLKIT}" = "android" -o "${MOZ_WIDGET_TOOLKIT}" = "gtk2"; then
 MOZ_ENABLE_SKIA=1
 else
 MOZ_ENABLE_SKIA=
 fi
 
 MOZ_ARG_ENABLE_BOOL(skia,
 [  --enable-skia   Enable use of Skia],
 MOZ_ENABLE_SKIA=1,
diff --git a/gfx/2d/moz.build b/gfx/2d/moz.build
--- a/gfx/2d/moz.build
+++ b/gfx/2d/moz.build
@@ -39,25 +39,22 @@ if CONFIG['MOZ_WIDGET_TOOLKIT'] == 'coco
     ]
 elif CONFIG['MOZ_WIDGET_TOOLKIT'] == 'windows':
     CPP_SOURCES += [
         'DrawTargetD2D.cpp',
         'SourceSurfaceD2D.cpp',
         'SourceSurfaceD2DTarget.cpp',
         'PathD2D.cpp',
         'ScaledFontDWrite.cpp',
+	'ScaledFontWin.cpp',
     ]
     if CONFIG['MOZ_WINSDK_MAXVER'] >= '0x06020000':
         CPP_SOURCES += [
             'RadialGradientEffectD2D1.cpp'
         ]
-    if CONFIG['MOZ_ENABLE_SKIA']:
-        CPP_SOURCES += [
-            'ScaledFontWin.cpp',
-        ]
 
 if CONFIG['MOZ_ENABLE_SKIA']:
     CPP_SOURCES += [
         'SourceSurfaceSkia.cpp',
         'DrawTargetSkia.cpp',
         'PathSkia.cpp',
         'convolver.cpp',
         'image_operations.cpp',
diff --git a/gfx/thebes/gfxWindowsPlatform.cpp b/gfx/thebes/gfxWindowsPlatform.cpp
--- a/gfx/thebes/gfxWindowsPlatform.cpp
+++ b/gfx/thebes/gfxWindowsPlatform.cpp
@@ -500,17 +500,17 @@ gfxWindowsPlatform::UpdateRenderMode()
     }
 #endif
 
     uint32_t canvasMask = 1 << BACKEND_CAIRO;
     uint32_t contentMask = 0;
     if (mRenderMode == RENDER_DIRECT2D) {
       canvasMask |= 1 << BACKEND_DIRECT2D;
       contentMask |= 1 << BACKEND_DIRECT2D;
-    } else {
+    } else if (!mUseDirectWrite) {
       canvasMask |= 1 << BACKEND_SKIA;
     }
     InitBackendPrefs(canvasMask, contentMask);
 }
 
 #ifdef CAIRO_HAS_D2D_SURFACE
 HRESULT
 gfxWindowsPlatform::CreateDevice(nsRefPtr<IDXGIAdapter1> &adapter1,

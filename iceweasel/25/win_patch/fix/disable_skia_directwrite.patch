# HG changeset patch
# Parent 6ef0890b33e42ab4e80d5f22a25bda4221b7a9dc
# User hua.andy <hua.andy@gmail.com>
"disable-skia configure for windows"


diff --git a/configure.in b/configure.in
--- a/configure.in
+++ b/configure.in
@@ -8039,18 +8039,17 @@ dnl ====================================
 
 if test "${OS_TARGET}" = "WINNT"; then
   if $PERL -e "exit($MOZ_WINSDK_MAXVER < 0x06020000)"; then
     MOZ_ENABLE_DIRECT2D1_1=1
     AC_SUBST(MOZ_ENABLE_DIRECT2D1_1)
   fi
 fi
 
-if test "${OS_TARGET}" = "WINNT" -o \
-        "${OS_ARCH}" = "Darwin" -o \
+if test "${OS_ARCH}" = "Darwin" -o \
         "${MOZ_WIDGET_TOOLKIT}" = "android" -o \
         "${MOZ_WIDGET_TOOLKIT}" = "gonk" -o \
         "${MOZ_WIDGET_TOOLKIT}" = "gtk2"; then
     case "${target_cpu}" in
     i*86*|x86_64|arm)
         MOZ_ENABLE_SKIA=1
         ;;
     *)
diff --git a/gfx/2d/moz.build b/gfx/2d/moz.build
--- a/gfx/2d/moz.build
+++ b/gfx/2d/moz.build
@@ -43,27 +43,24 @@ if CONFIG['MOZ_WIDGET_TOOLKIT'] == 'coco
     ]
 elif CONFIG['MOZ_WIDGET_TOOLKIT'] == 'windows':
     CPP_SOURCES += [
         'DrawTargetD2D.cpp',
         'SourceSurfaceD2D.cpp',
         'SourceSurfaceD2DTarget.cpp',
         'PathD2D.cpp',
         'ScaledFontDWrite.cpp',
+	'ScaledFontWin.cpp',
     ]
     if CONFIG['MOZ_ENABLE_DIRECT2D1_1']:
         CPP_SOURCES += [
             'RadialGradientEffectD2D1.cpp',
             'DrawTargetD2D1.cpp',
             'SourceSurfaceD2D1.cpp'
         ]
-    if CONFIG['MOZ_ENABLE_SKIA']:
-        CPP_SOURCES += [
-            'ScaledFontWin.cpp',
-        ]
 
 if CONFIG['MOZ_ENABLE_SKIA']:
     CPP_SOURCES += [
         'SourceSurfaceSkia.cpp',
         'DrawTargetSkia.cpp',
         'PathSkia.cpp',
         'convolver.cpp',
         'image_operations.cpp',
diff --git a/gfx/thebes/gfxWindowsPlatform.cpp b/gfx/thebes/gfxWindowsPlatform.cpp
--- a/gfx/thebes/gfxWindowsPlatform.cpp
+++ b/gfx/thebes/gfxWindowsPlatform.cpp
@@ -501,17 +501,17 @@ gfxWindowsPlatform::UpdateRenderMode()
     }
 #endif
 
     uint32_t canvasMask = 1 << BACKEND_CAIRO;
     uint32_t contentMask = 0;
     if (mRenderMode == RENDER_DIRECT2D) {
       canvasMask |= 1 << BACKEND_DIRECT2D;
       contentMask |= 1 << BACKEND_DIRECT2D;
-    } else {
+    } else if (!mUseDirectWrite) {
       canvasMask |= 1 << BACKEND_SKIA;
     }
     InitBackendPrefs(canvasMask, contentMask);
 }
 
 #ifdef CAIRO_HAS_D2D_SURFACE
 HRESULT
 gfxWindowsPlatform::CreateDevice(nsRefPtr<IDXGIAdapter1> &adapter1,
